# Design Document: Email-Only Registration

## Overview

This design document outlines the technical approach for migrating the TripRadar registration system from username-based to email-only registration. The backend API has been updated to remove the username requirement and automatically generate usernames from email addresses. This document describes the frontend changes needed to align with the new API schema while maintaining a smooth user experience.

The migration involves:

- Removing the username field from the registration form
- Adding optional profile fields (firstName, lastName, phoneNumber)
- Adding promo code support
- Updating TypeScript types from the Swagger specification
- Ensuring email confirmation flow works with auto-generated usernames
- Maintaining Google OAuth functionality

## Architecture

### High-Level Flow

```
User Registration Flow:
1. User fills registration form (email, password, optional fields)
2. Frontend validates input
3. POST /api/v1/users (without username)
4. Backend generates username from email
5. Backend sends confirmation email
6. User clicks email link → GET /api/v1/users/{username}/email-confirmations?token=xxx
7. Backend confirms email (302 redirect)
8. User redirected to success page
9. User logs in with email
```

### Component Architecture (FSD)

Following Feature-Sliced Design principles:

```
src/
├── features/auth/
│   ├── ui/
│   │   ├── Signup.tsx              # Updated registration form
│   │   ├── Login.tsx               # Updated to emphasize email login
│   │   └── OAuthButtons.tsx        # No changes needed
│   ├── api/
│   │   ├── useRegister.ts          # Updated mutation
│   │   ├── useLogin.ts             # No changes needed
│   │   └── authApi.ts              # Updated types
│   └── lib/
│       └── oauth.ts                # Updated to handle email-only
├── pages/auth/
│   ├── EmailSent.tsx               # No changes needed
│   ├── EmailConfirmed.tsx          # Updated to handle username from URL
│   └── ForgotPassword.tsx          # No changes needed
├── shared/
│   ├── api/
│   │   ├── generated-types.ts      # Regenerated from Swagger
│   │   └── index.ts                # Updated type exports
│   └── ui/
│       └── FormInput/              # Reusable form components
└── app/
    └── router/routes.tsx           # Updated email confirmation route
```

## Components and Interfaces

### 1. Updated Signup Component

**Location:** `src/features/auth/ui/Signup.tsx`

**Changes:**

- Remove username field from form
- Add optional fields: firstName, lastName, phoneNumber
- Add optional promo code field
- Update form validation
- Update API request payload

**Interface:**

```typescript
interface SignupFormData {
  email: string; // Required
  password: string; // Required
  hasDataStorageConsent: boolean; // Required
  firstName?: string; // Optional (new)
  lastName?: string; // Optional (new)
  phoneNumber?: string; // Optional (new)
  promoCode?: string; // Optional (new)
}
```

### 2. Updated Registration API

**Location:** `src/features/auth/api/useRegister.ts`

**Changes:**

- Update mutation to use new CreateUserRequest type
- Remove username from request payload
- Add optional fields to request

**API Request:**

```typescript
POST /api/v1/users
{
  email: string;
  password: string;
  hasDataStorageConsent: boolean;
  firstName?: string | null;
  lastName?: string | null;
  phoneNumber?: string | null;
  promoCode?: string | null;
}
```

**API Response:**

```typescript
{
  message: string;
  username?: string;  // Auto-generated by backend
}
```

### 3. Email Confirmation Handler

**Location:** `src/pages/auth/EmailConfirmation.tsx` (new component)

**Purpose:** Handle the email confirmation link click

**Flow:**

1. Extract token and username from URL query params
2. Call GET /api/v1/users/{username}/email-confirmations?token={token}
3. Handle 302 redirect or error
4. Show success/error message

**Interface:**

```typescript
interface EmailConfirmationProps {
  // Extracted from URL: /confirm-email?username=xxx&token=xxx
}
```

### 4. Updated Login Component

**Location:** `src/features/auth/ui/Login.tsx`

**Changes:**

- Update placeholder text to emphasize email
- Keep usernameOrEmail field (backend still accepts both)
- Update error handling for EmailNotConfirmed

### 5. Updated OAuth Handler

**Location:** `src/features/auth/lib/oauth.ts`

**Changes:**

- Remove username extraction logic
- Backend will generate username from Google email
- Extract firstName/lastName from Google profile

## Data Models

### CreateUserRequest (from Swagger)

```typescript
interface CreateUserRequest {
  email: string; // Required, format: email
  password: string; // Required
  hasDataStorageConsent: boolean; // Required
  firstName?: string | null; // Optional
  lastName?: string | null; // Optional
  phoneNumber?: string | null; // Optional
  promoCode?: string | null; // Optional
}
```

### CreateLoginRequest (unchanged)

```typescript
interface CreateLoginRequest {
  usernameOrEmail: string; // Can be email or auto-generated username
  password: string;
}
```

### GetUserProfileResponse (from Swagger)

```typescript
interface GetUserProfileResponse {
  username: string; // Auto-generated by backend
  email: string;
  isEmailConfirmed: boolean;
  firstName?: string | null;
  lastName?: string | null;
  phoneNumber?: string | null;
  googleId?: string | null;
  timezone: string;
  profilePictureUrl?: string | null;
  languageCode?: string | null;
  languageName?: string | null;
  countryCode?: string | null;
  countryName?: string | null;
  allowsMarketingEmails: boolean;
  isActive: boolean;
  tierName: string;
  createdOn: string;
  updatedOn?: string | null;
}
```

## Correctness Properties

_A property is a characteristic or behavior that should hold true across all valid executions of a system-essentially, a formal statement about what the system should do. Properties serve as the bridge between human-readable specifications and machine-verifiable correctness guarantees._

### Property 1: Registration request excludes username

_For any_ registration form submission, the API request payload should not contain a username field
**Validates: Requirements 1.2, 1.3**

### Property 2: API errors are displayed to users

_For any_ backend error response, the error message should be displayed in the UI
**Validates: Requirements 1.5, 9.1**

### Property 3: Optional fields are included when filled

_For any_ registration form submission where optional fields (firstName, lastName, phoneNumber) have non-empty values, those values should be included in the API request
**Validates: Requirements 2.2**

### Property 4: Optional field validation errors are shown

_For any_ invalid input in optional fields, an appropriate validation error message should be displayed
**Validates: Requirements 2.5**

### Property 5: Promo code is included when provided

_For any_ registration form submission with a non-empty promo code, the promo code should be included in the API request
**Validates: Requirements 3.2**

### Property 6: Promo code errors are displayed

_For any_ backend rejection of a promo code, the error message should be displayed to the user
**Validates: Requirements 3.4**

### Property 7: Email confirmation errors are handled

_For any_ email confirmation failure, an error message with instructions should be displayed
**Validates: Requirements 4.4**

### Property 8: Email format is accepted in login

_For any_ valid email address entered in the login form, it should be accepted as a valid usernameOrEmail value
**Validates: Requirements 5.1**

### Property 9: Login tokens are stored

_For any_ successful login response, the authentication tokens should be stored in localStorage
**Validates: Requirements 5.3**

### Property 10: Username from login is stored in state

_For any_ login response containing a username, that username should be stored in the auth state
**Validates: Requirements 5.4**

### Property 11: OAuth tokens are stored

_For any_ successful Google OAuth response, the returned authentication tokens should be stored in localStorage
**Validates: Requirements 7.3**

### Property 12: Google profile data is extracted

_For any_ Google OAuth success, firstName and lastName should be extracted from the Google profile and included in the user data
**Validates: Requirements 7.4**

### Property 13: Invalid email formats show errors

_For any_ invalid email format entered in the registration form, an error message should be displayed below the email field
**Validates: Requirements 8.1**

### Property 14: Validation errors clear when corrected

_For any_ form field with a validation error, when the user enters valid data, the error message should be removed
**Validates: Requirements 8.4**

### Property 15: Submit button enabled when form valid

_For any_ registration form state where all required fields are valid, the submit button should be enabled
**Validates: Requirements 8.5**

### Property 16: Error logging to console

_For any_ error that occurs during registration or login, error details should be logged to the console
**Validates: Requirements 9.5**

## Error Handling

### Registration Errors

| Error Type           | HTTP Status | Handling                                                    |
| -------------------- | ----------- | ----------------------------------------------------------- |
| Invalid email format | 400         | Display validation error below email field                  |
| Email already exists | 400         | Display "Email already registered. Try logging in instead." |
| Invalid promo code   | 400         | Display error message from backend                          |
| Weak password        | 400         | Display password requirements                               |
| Missing consent      | 400         | Display "You must agree to continue"                        |
| Network error        | -           | Display "Network error. Please try again."                  |
| Server error         | 500         | Display "Server error. Please try again later."             |

### Email Confirmation Errors

| Error Type        | HTTP Status | Handling                                           |
| ----------------- | ----------- | -------------------------------------------------- |
| Invalid token     | 400         | Display "Invalid or expired confirmation link"     |
| User not found    | 404         | Display "User not found"                           |
| Already confirmed | 400         | Display "Email already confirmed. You can log in." |
| Network error     | -           | Display "Network error. Please try again."         |

### Login Errors

| Error Type          | HTTP Status | Handling                                                               |
| ------------------- | ----------- | ---------------------------------------------------------------------- |
| Invalid credentials | 401         | Display "Invalid email or password"                                    |
| Email not confirmed | 400         | Display "Please confirm your email before logging in" with resend link |
| Account disabled    | 403         | Display "Account disabled. Contact support."                           |
| Network error       | -           | Display "Network error. Please try again."                             |

## Testing Strategy

### Unit Testing

**Test Coverage:**

- Form validation logic (email format, password length, required fields)
- API request payload structure (no username, optional fields included/excluded)
- Error message display logic
- Navigation after successful registration
- Token storage after login
- OAuth data extraction

**Example Unit Tests:**

```typescript
describe('Signup Form', () => {
  it('should not include username in registration request', () => {
    // Test that API call excludes username field
  });

  it('should include optional fields when filled', () => {
    // Test that firstName, lastName are included when provided
  });

  it('should display backend error messages', () => {
    // Test error display for various error responses
  });
});
```

### Property-Based Testing

**Library:** `fast-check` (JavaScript/TypeScript property testing library)

**Configuration:** Minimum 100 iterations per property test

**Property Tests:**

1. **Property 1: Registration request excludes username**
   - Generate random registration data
   - Verify API request never contains username field

2. **Property 2: API errors are displayed**
   - Generate random error messages
   - Verify all errors are displayed in UI

3. **Property 3: Optional fields included when filled**
   - Generate random optional field values
   - Verify they appear in API request

4. **Property 8: Email format accepted in login**
   - Generate random valid emails
   - Verify they are accepted in login form

5. **Property 13: Invalid email formats show errors**
   - Generate random invalid emails
   - Verify error messages are displayed

6. **Property 14: Validation errors clear when corrected**
   - Generate random invalid then valid inputs
   - Verify errors disappear

### Integration Testing

**Test Scenarios:**

- Complete registration flow (form → API → email sent page)
- Email confirmation flow (link click → API → success page)
- Login with email after registration
- Google OAuth registration flow
- Error handling for duplicate email
- Error handling for invalid promo code

### Manual Testing Checklist

- [ ] Registration form displays without username field
- [ ] Optional fields (firstName, lastName, phoneNumber) are clearly marked
- [ ] Promo code field is optional
- [ ] Form validation works for all fields
- [ ] Registration succeeds and redirects to email sent page
- [ ] Email confirmation link works
- [ ] Login with email works
- [ ] Google OAuth works without username
- [ ] Error messages are clear and helpful
- [ ] Mobile responsive design works

## Migration Steps

### Phase 1: Update Types (No UI Changes)

1. Update package.json with correct Swagger URL
2. Run `npm run generate-types`
3. Update type imports in auth files
4. Fix TypeScript errors

### Phase 2: Update Registration Form

1. Remove username field from Signup.tsx
2. Add optional fields (firstName, lastName, phoneNumber)
3. Add promo code field
4. Update form validation
5. Update API request payload

### Phase 3: Update Email Confirmation

1. Create EmailConfirmation component
2. Add route for /confirm-email
3. Handle token and username from URL
4. Call confirmation API
5. Handle success/error states

### Phase 4: Update Login Flow

1. Update Login.tsx placeholder text
2. Update error handling for EmailNotConfirmed
3. Test login with email

### Phase 5: Update OAuth

1. Update oauth.ts to remove username logic
2. Test Google OAuth flow

### Phase 6: Testing

1. Write unit tests
2. Write property-based tests
3. Run integration tests
4. Manual testing
5. Fix bugs

### Phase 7: Deployment

1. Deploy to staging
2. Test on staging
3. Deploy to production
4. Monitor for errors

## Security Considerations

1. **Email Validation:** Validate email format on frontend and backend
2. **Password Strength:** Enforce minimum 6 characters (consider increasing)
3. **HTTPS Only:** All API calls must use HTTPS
4. **Token Security:** Email confirmation tokens should be single-use and expire
5. **Rate Limiting:** Implement rate limiting on registration endpoint
6. **XSS Protection:** Sanitize all user inputs before display
7. **CSRF Protection:** Use CSRF tokens for form submissions

## Performance Considerations

1. **Form Validation:** Use debouncing for real-time validation
2. **API Calls:** Show loading states during registration
3. **Error Handling:** Cache error messages to avoid re-fetching
4. **OAuth:** Optimize OAuth flow to minimize redirects
5. **Bundle Size:** Ensure form validation doesn't bloat bundle

## Accessibility

1. **Form Labels:** All inputs must have associated labels
2. **Error Messages:** Use aria-describedby for error messages
3. **Focus Management:** Focus on first error field after validation
4. **Keyboard Navigation:** Ensure all interactive elements are keyboard accessible
5. **Screen Readers:** Announce validation errors and success messages

## Future Enhancements

1. **Password Strength Indicator:** Add visual password strength meter
2. **Email Verification:** Add "Resend confirmation email" button
3. **Social Login:** Add more OAuth providers (GitHub, Microsoft)
4. **Profile Completion:** Prompt users to complete profile after registration
5. **Username Customization:** Allow users to change auto-generated username
6. **Phone Verification:** Add SMS verification for phone numbers
7. **Two-Factor Authentication:** Add 2FA support
